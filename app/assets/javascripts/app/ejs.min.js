(function(){var rsplit=function(e,t){var n=t.exec(e),r=new Array,i,s,o;while(n!=null)i=n.index,s=t.lastIndex,i!=0&&(o=e.substring(0,i),r.push(e.substring(0,i)),e=e.slice(i)),r.push(n[0]),e=e.slice(n[0].length),n=t.exec(e);return!e==""&&r.push(e),r},chop=function(e){return e.substr(0,e.length-1)};EJS=function(e,t){t||(t={}),this.emitter=t.emitter,this.isTemplate=t.isTemplate;var n;this.isTemplate?n=new Compiler(e,{isTemplate:this.isTemplate,parent:this}):(this.text=e,n=new Compiler(this.text,{parent:this}),n.compile()),this.template=n};var extendHelper=function(e,t){if(t)if(t instanceof Array)for(var n=0;n<t.length;n++)extend(e.helper,t[n]);else extend(e.helper,t)},splitEmitter=function(e){if(typeof e=="string"){var t={},n=e.split("#");return t.controller=n[0],t.action=n[1],t=t,t}return e};EJS.renderPartial=function(e,t,n,r){e=splitEmitter(e),e.type="partial",EJS.renderTemplate.call(this,e,t,n,r)},EJS.queue=[],EJS.renderTemplate=function(e,t,n,r){EJS.queue.push(arguments),EJS.queue.length<2&&render(e,t,n,r)};var render=function(e,t,n,r){e=splitEmitter(e),typeof t=="function"&&(r=n,n=t,t=e);var i=EJS.Storage.find(e);if(i)extendHelper(i,r),i.render({callback:n,data:t});else{var i=new EJS("",{emitter:e});i.isDummy=!0,i.callback=n,i.helper=new Helpers(i),i.data=t,extendHelper(i,r),EJS.Storage.render(e,t,i,i.helper)}};EJS.prototype={render:function(e,t){typeof e=="function"?this.callback=e:(e=e||{},t=t||e),this.data||(this.data=t),this.parent||(this.parent=e.parent||this),this.callback||(this.callback=e.callback),this.helper||(this.helper=e.helper||new Helpers(this.parent));var n=t.helpers||e.helpers;extendHelper(this,n),extend(this.data,e.data||t),extend(this.data,this.emitter),this.stopRender=!1;var r=this.template.process(this.data,this.helper);if(!this.stopRender&&this.callback)EJS.Storage.rootTemplate=null,this.callback.call(this,r),this.callback=null,EJS.queue.shift(),EJS.queue.length&&render.apply(EJS,EJS.queue[0]);else if(!this.callback)return r},out:function(){return this.template.out}};var Scanner=function(e){this.left_delimiter="<%",this.right_delimiter="%>",this.double_left="<%%",this.double_right="%%>",this.left_equal="<%=",this.left_comment="<%#",this.SplitRegexp=new RegExp("("+this.double_left+")|(%%"+this.double_right+")|("+this.left_equal+")|("+this.left_comment+")|("+this.left_delimiter+")|("+this.right_delimiter+"\n)|("+this.right_delimiter+")|(\n)"),this.source=e,this.stag=null,this.lines=0};Scanner.prototype={scan:function(e){var t=this.SplitRegexp;if(!this.source==""){var n=rsplit(this.source,/\n/);for(var r=0;r<n.length;r++){var i=n[r];this.scanline(i,t,e)}}},scanline:function(e,t,n){this.lines++;var r=rsplit(e,t);for(var i=0;i<r.length;i++){var s=r[i];if(s!=null)try{n(s,this)}catch(o){throw{type:"Scanner",line:this.lines}}}}};var Buffer=function(e,t){this.line=new Array,this.script="",this.pre_cmd=e,this.post_cmd=t;for(var n=0;n<this.pre_cmd.length;n++)this.push(e[n])};Buffer.prototype={push:function(e){this.line.push(e)},cr:function(){this.script=this.script+this.line.join(";"),this.line=new Array,this.script=this.script+"\n"},close:function(){if(this.line.length>0){for(var e=0;e<this.post_cmd.length;e++)this.push(this.post_cmd[e]);this.script=this.script+this.line.join(";"),line=null}}};var Compiler=function(e,t){this.isTemplate=t.isTemplate,this.emitter=t.parent.emitter,this.pre_cmd=["var _$ = (function(){ var _$ = []","_$.p = _$.push","_t = to_text"],this.post_cmd=["return _$;})()"],this.source=" ",e!=null&&!this.isTemplate&&(typeof e=="string"&&(e=e.replace(/\r\n/g,"\n"),e=e.replace(/\r/g,"\n"),this.source=e),typeof this.source!="string"&&(this.source="")),this.isTemplate?(this.out=e,this.compile()):(this.scanner=new Scanner(this.source),this.out="")};Compiler.prototype={compile:function(){if(!this.isTemplate){this.out="";var put_cmd="_$.p(",insert_cmd=put_cmd,buff=new Buffer(this.pre_cmd,this.post_cmd),content="",clean=function(e){return e=e.replace(/\\/g,"\\\\"),e=e.replace(/\n/g,"\\n"),e=e.replace(/"/g,'\\"'),e};this.scanner.scan(function(e,t){if(t.stag==null)switch(e){case"\n":content+="\n",buff.push(put_cmd+'"'+clean(content)+'");'),buff.cr(),content="";break;case t.left_delimiter:case t.left_equal:case t.left_comment:t.stag=e,content.length>0&&buff.push(put_cmd+'"'+clean(content)+'")'),content="";break;case t.double_left:content+=t.left_delimiter;break;default:content+=e}else switch(e){case t.right_delimiter:switch(t.stag){case t.left_delimiter:content[content.length-1]=="\n"?(content=chop(content),buff.push(content),buff.cr()):buff.push(content);break;case t.left_equal:buff.push(insert_cmd+"_t("+content+"))")}t.stag=null,content="";break;case t.double_right:content+=t.right_delimiter;break;default:content+=e}}),content.length>0&&buff.push(put_cmd+'"'+clean(content)+'")'),buff.close(),this.out=buff.script+";"}this.process=function(_context,_helper){_helper||(_helper={});try{with(_helper)with(_context)return eval(this.out),_$.join("")}catch(e){var msg=["Error in template",this.emitter.controller+"#"+this.emitter.action,e.type,e.arguments];throw e.message=msg.join(" "),e}}}};var extend=function(e,t){if(t)for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])},Camelize=function(e){return e?e.split("_").map(function(e){return e?e.charAt(0).toUpperCase()+e.slice(1):""}).join(""):e},Underscore=function(e){if(!e)return e;var t=function(e,t){return t?"_"+e.toLowerCase():e.toLowerCase()};return e.replace(/[A-Z]/g,t)},Helpers=function(e){this.parent=e};(function(){this.render=function(e){if(this.parent.stopRender)return;e.locals||(e.locals={}),e.controller||(e.controller=this.parent.emitter.controller);var t={controller:e.controller};return e.url&&(t.url=e.url),e.partial&&(t.type="partial"),extend(e.locals,e.emitter),t.action=e.partial?Camelize(e.partial):Camelize(e.template),EJS.Storage.render(t,e.locals,this.parent,this)};var e=function(e,t){return"<"+e+n(t)+">"},t=function(e){return"</"+e+">"},n=function(e){var t=" ",n=[];for(var r in e)n.push(""+r+'="'+e[r]+'"');return t+n.join(" ")};this.to_text=function(e){return e==null||e===undefined?"":e instanceof Date?e.toDateString():e.toString?e.toString():""},this.link_to=function(n,r,i){return i=i||{},extend(i,{href:n}),e("a",i)+r+t("a")}}).call(Helpers.prototype),EJSStorage=function(){this.templates={},this.partials={},this.initialize()},function(){this.initialize=function(){typeof window=="undefined"&&(window=global||{}),window.localStorage?this.saveLocal=!0:this.saveLocal=!1},this.newTemplate=function(e,t){var n=new EJS(t,{emitter:e});return this.push(e,n),this.save(e,n),n},this.save=function(e,t){if(!this.saveLocal)return;t.emitter.type=="partial"?u.call(this,t):o.call(this,t)},this.push=function(e,r){return e.type=="partial"?n.call(this,r):t.call(this,r)},this.find=function(e){return e.controller=Camelize(e.controller),e.action=Camelize(e.action),e.type=="partial"?i.call(this,e):r.call(this,e)},this.render=function(e,t,n,r){this.rootTemplate=n;var i;if(i=this.find(e))return i.render({data:t,parent:n,helper:r});n.stopRender=!0;try{this.load(e)}catch(s){throw"you must define load method\n"+s}return!1},this.rootTemplate=null,this.load=null,this.superLoad=function(t,n){if(!n)throw"Error. Template "+e(t)+" not found";var r=/\s\s*$/,i=this.newTemplate(t,n.replace(r,""));this.rootTemplate&&this.rootTemplate.isDummy&&(i.callback=this.rootTemplate.callback,i.helper=this.rootTemplate.helper,i.data=this.rootTemplate.data,i.helper.parent=i,this.rootTemplate=i),this.rootTemplate?this.rootTemplate.render():i.render()};var e=function(e){return e.controller+"#"+e.action},t=function(t){this.templates[e(t.emitter)]=t},n=function(t){this.partials[e(t.emitter)]=t},r=function(t){return this.templates[e(t)]},i=function(t){return this.partials[e(t)]},s=function(){var e=localStorage.length;for(var t=0;t<e;t++){var n=localStorage.key(t);if(!n)continue;var r=n.split(/#/);if(!r||r.length!=2)continue;localStorage.removeItem(n)}},o=function(t){try{localStorage.setItem(e(t.emitter),t.out())}catch(n){s(),o.call(this,t)}},u=function(t){try{t.emitter.action="_"+t.emitter.action,localStorage.setItem(e(t.emitter),t.out())}catch(n){s(),u.call(this,t)}},a=function(e){localStorage.setItem("ServerRestartTime",e)},f=function(){var e;return(e=localStorage.getItem("ServerRestartTime"))?new Date(e):null};this.checkServerRestartDate=function(e){if(!this.saveLocal)return;var t=f();t<e-3e3?(s(),e instanceof Date&&a(e)):l.call(this)};var l=function(){var e=localStorage.length;for(var t=0;t<e;t++){var n=localStorage.key(t),r=n.split(/#/);if(!r||r.length!=2)continue;var i={controller:r[0],action:r[1]};r[1].charAt(0)=="_"?h.call(this,i):c.call(this,i)}},c=function(t){var n;if(n=localStorage.getItem(e(t))){var r=new EJS(n,{emitter:t,isTemplate:!0});this.push(t,r)}},h=function(t){var n;if(n=localStorage.getItem(e(t))){t.action=Camelize(t.action);var r=new EJS(n,{emitter:t,isTemplate:!0});t.type="partial",this.push(t,r)}}}.call(EJSStorage.prototype),EJS.Storage=new EJSStorage})()